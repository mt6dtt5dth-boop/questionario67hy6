<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso ao Question√°rio - Newdri Clinic</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <header class="clinic-header">
            <h1>üå∏ Newdri Clinic</h1>
            <p class="subtitle">Question√°rio de Avalia√ß√£o de Intimidade e Bem-Estar</p>
        </header>

        <div class="card" style="max-width: 600px; margin: 40px auto;">
            <h2>üîê Acesso ao Question√°rio</h2>
            
            <p class="intro-text">
                Para iniciar o question√°rio, digite o c√≥digo de acesso fornecido pelo seu terapeuta.
            </p>

            <div class="info-box">
                <h3>üìã Informa√ß√µes Importantes</h3>
                <ul>
                    <li><strong>Tempo estimado:</strong> 20-30 minutos</li>
                    <li><strong>Total de quest√µes:</strong> 66 quest√µes + dados demogr√°ficos</li>
                    <li><strong>Confidencialidade:</strong> Suas respostas s√£o totalmente confidenciais</li>
                    <li><strong>Validade:</strong> Cada c√≥digo pode ser usado apenas uma vez</li>
                </ul>
            </div>

            <div class="form-group" style="margin-top: 30px;">
                <label for="codigoAcesso">C√≥digo de Acesso:</label>
                <input 
                    type="text" 
                    id="codigoAcesso" 
                    placeholder="Digite seu c√≥digo (8 caracteres)"
                    maxlength="8"
                    style="text-align: center; font-size: 1.5rem; letter-spacing: 4px; font-family: monospace; text-transform: uppercase;">
                <p style="font-size: 0.9rem; color: #7f8c8d; margin-top: 8px;">
                    Exemplo: ABC12345
                </p>
            </div>

            <button class="btn btn-primary" onclick="validarEAcessar()" style="width: 100%; margin-top: 20px;">
                ‚úÖ Acessar Question√°rio
            </button>

            <div id="mensagemErro" class="alert alert-danger" style="display: none; margin-top: 20px;"></div>
            <div id="mensagemSucesso" class="alert alert-success" style="display: none; margin-top: 20px;"></div>

            <div class="ethics-box" style="margin-top: 40px;">
                <h3>üîí Compromisso √âtico</h3>
                <p>
                    Este question√°rio √© utilizado exclusivamente em contexto terap√™utico, 
                    com garantia de confidencialidade absoluta. Suas respostas ser√£o analisadas 
                    apenas pelo seu terapeuta.
                </p>
            </div>
        </div>

        <div class="professional-info">
            <p>
                <strong>Profissional Respons√°vel:</strong> Dr. Newton Guimar√£es<br>
                <strong>Newdri Clinic</strong> - S√£o Louren√ßo/MG
            </p>
        </div>
    </div>

    <script src="js/supabase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar Supabase
            if (!initSupabase()) {
                mostrarErro('‚ö†Ô∏è Sistema n√£o configurado. Entre em contato com seu terapeuta.');
                return;
            }

            // Permitir validar com Enter
            document.getElementById('codigoAcesso').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    validarEAcessar();
                }
            });

            // Formatar c√≥digo enquanto digita (uppercase)
            document.getElementById('codigoAcesso').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });
        });

        async function validarEAcessar() {
            const codigoInput = document.getElementById('codigoAcesso');
            const codigo = codigoInput.value.trim().toUpperCase();

            // Limpar mensagens anteriores
            document.getElementById('mensagemErro').style.display = 'none';
            document.getElementById('mensagemSucesso').style.display = 'none';

            // Valida√ß√µes b√°sicas
            if (!codigo) {
                mostrarErro('‚ùå Por favor, digite o c√≥digo de acesso.');
                codigoInput.focus();
                return;
            }

            if (codigo.length !== 8) {
                mostrarErro('‚ùå O c√≥digo deve ter exatamente 8 caracteres.');
                codigoInput.focus();
                return;
            }

            // Mostrar loading
            const btnAcessar = event.target;
            const textoOriginal = btnAcessar.innerHTML;
            btnAcessar.innerHTML = '<div class="loading" style="display: inline-block;"></div> Validando...';
            btnAcessar.disabled = true;

            // Validar c√≥digo no banco de dados
            const resultado = await validarCodigo(codigo);

            btnAcessar.innerHTML = textoOriginal;
            btnAcessar.disabled = false;

            if (!resultado.valido) {
                mostrarErro('‚ùå ' + resultado.erro);
                codigoInput.focus();
                return;
            }

            // C√≥digo v√°lido! Salvar na sess√£o e redirecionar
            mostrarSucesso('‚úÖ C√≥digo v√°lido! Redirecionando para o question√°rio...');
            
            // Salvar c√≥digo na sess√£o
            sessionStorage.setItem('codigo_acesso', codigo);
            sessionStorage.setItem('codigo_validado', 'true');

            // Redirecionar ap√≥s 1 segundo
            setTimeout(() => {
                window.location.href = 'questionario.html';
            }, 1000);
        }

        function mostrarErro(mensagem) {
            const divErro = document.getElementById('mensagemErro');
            divErro.textContent = mensagem;
            divErro.style.display = 'block';
            
            // Scroll at√© a mensagem
            divErro.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function mostrarSucesso(mensagem) {
            const divSucesso = document.getElementById('mensagemSucesso');
            divSucesso.textContent = mensagem;
            divSucesso.style.display = 'block';
            
            // Scroll at√© a mensagem
            divSucesso.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    </script>
</body>
</html>

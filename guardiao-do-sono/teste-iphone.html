<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ğŸ”Š Teste de Ãudio iPhone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .status {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            min-width: 300px;
            max-width: 90%;
        }
        
        .status-line {
            font-size: 0.9rem;
            margin: 5px 0;
            font-family: 'Courier New', monospace;
        }
        
        button {
            background: white;
            color: #667eea;
            border: none;
            padding: 20px 40px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 250px;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            max-width: 90%;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            text-align: left;
        }
        
        .log-line {
            margin: 3px 0;
        }
        
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196f3; }
    </style>
</head>
<body>
    <h1>ğŸ”Š Teste de Ãudio iPhone</h1>
    
    <div class="status">
        <div class="status-line">ğŸ“± Dispositivo: <span id="device">Detectando...</span></div>
        <div class="status-line">ğŸŒ Navegador: <span id="browser">Detectando...</span></div>
        <div class="status-line">ğŸµ AudioContext: <span id="audio-context">Verificando...</span></div>
        <div class="status-line">ğŸ”Š Ãudio HTML5: <span id="html5-audio">Verificando...</span></div>
    </div>
    
    <button id="test-btn" onclick="testAudio()">ğŸ§ TESTAR ÃUDIO</button>
    <button id="test-silent" onclick="testSilent()">ğŸ”‡ Testar Ãudio Silencioso</button>
    <button id="test-context" onclick="testAudioContext()">ğŸ›ï¸ Testar AudioContext</button>
    
    <div class="log" id="log"></div>
    
    <script>
        let audio = null;
        let audioContext = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        // Detectar dispositivo
        function detectDevice() {
            const ua = navigator.userAgent;
            const isIOS = /iPhone|iPad|iPod/i.test(ua);
            const isAndroid = /Android/i.test(ua);
            const isSafari = /Safari/i.test(ua) && !/Chrome/i.test(ua);
            
            document.getElementById('device').textContent = 
                isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop';
            
            document.getElementById('browser').textContent = 
                isSafari ? 'Safari' : /Chrome/i.test(ua) ? 'Chrome' : 'Outro';
            
            log(`Dispositivo: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'}`, 'info');
            log(`User-Agent: ${ua.substring(0, 100)}`, 'info');
            
            return { isIOS, isAndroid, isSafari };
        }
        
        // Verificar AudioContext
        function checkAudioContext() {
            try {
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                if (AudioContextClass) {
                    audioContext = new AudioContextClass();
                    document.getElementById('audio-context').textContent = `âœ… ${audioContext.state}`;
                    log(`AudioContext criado: state=${audioContext.state}`, 'success');
                    return true;
                } else {
                    document.getElementById('audio-context').textContent = 'âŒ NÃ£o suportado';
                    log('AudioContext nÃ£o disponÃ­vel', 'error');
                    return false;
                }
            } catch (e) {
                document.getElementById('audio-context').textContent = 'âŒ Erro';
                log(`Erro ao criar AudioContext: ${e.message}`, 'error');
                return false;
            }
        }
        
        // Verificar suporte HTML5 Audio
        function checkHTML5Audio() {
            const testAudio = new Audio();
            const canPlayMP3 = testAudio.canPlayType('audio/mpeg');
            document.getElementById('html5-audio').textContent = 
                canPlayMP3 ? `âœ… ${canPlayMP3}` : 'âŒ NÃ£o suporta MP3';
            log(`HTML5 Audio MP3 support: ${canPlayMP3}`, canPlayMP3 ? 'success' : 'error');
        }
        
        // Testar Ã¡udio silencioso (unlock para iOS)
        async function testSilent() {
            log('ğŸ”‡ Testando Ã¡udio silencioso...', 'info');
            
            const silentAudio = new Audio();
            silentAudio.src = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhAC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAA4T0DIwcAAAAAAAAAAAAAAAAAAAA//sQZAAP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAETEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVQ==';
            silentAudio.volume = 0.01;
            
            try {
                await silentAudio.play();
                log('âœ… Ãudio silencioso tocou com sucesso', 'success');
                silentAudio.pause();
                silentAudio.remove();
                
                // Verificar AudioContext novamente
                if (audioContext && audioContext.state === 'suspended') {
                    log('â¯ï¸ Tentando resumir AudioContext...', 'info');
                    await audioContext.resume();
                    log(`âœ… AudioContext resumido: state=${audioContext.state}`, 'success');
                }
                
            } catch (e) {
                log(`âŒ Erro ao tocar Ã¡udio silencioso: ${e.message}`, 'error');
            }
        }
        
        // Testar AudioContext diretamente
        async function testAudioContext() {
            log('ğŸ›ï¸ Testando AudioContext...', 'info');
            
            if (!audioContext) {
                log('âŒ AudioContext nÃ£o inicializado', 'error');
                return;
            }
            
            log(`Estado atual: ${audioContext.state}`, 'info');
            
            if (audioContext.state === 'suspended') {
                log('â¯ï¸ Tentando resumir...', 'info');
                await audioContext.resume();
                log(`âœ… Resumido! Novo estado: ${audioContext.state}`, 'success');
            }
            
            // Tocar um tom simples
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 440; // LÃ¡ central
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                
                log('ğŸµ Tocando tom de 440Hz por 1 segundo...', 'info');
                
                setTimeout(() => {
                    oscillator.stop();
                    log('â¹ï¸ Tom finalizado', 'success');
                }, 1000);
                
            } catch (e) {
                log(`âŒ Erro ao tocar tom: ${e.message}`, 'error');
            }
        }
        
        // Testar Ã¡udio principal
        async function testAudio() {
            log('ğŸ§ INICIANDO TESTE DE ÃUDIO...', 'info');
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            
            // Se jÃ¡ existe Ã¡udio tocando, parar
            if (audio) {
                log('â¹ï¸ Parando Ã¡udio anterior...', 'warning');
                audio.pause();
                audio = null;
            }
            
            // Primeiro: desbloquear AudioContext
            if (audioContext && audioContext.state === 'suspended') {
                log('ğŸ”“ Desbloqueando AudioContext...', 'info');
                await audioContext.resume();
                log(`âœ… AudioContext: ${audioContext.state}`, 'success');
            }
            
            // Criar novo Ã¡udio
            const audioPath = 'audio/narrations/fase1_introducao.mp3';
            log(`ğŸ“ Carregando: ${audioPath}`, 'info');
            
            audio = new Audio();
            audio.preload = 'auto';
            
            // Eventos
            audio.onloadstart = () => log('ğŸ“¡ Iniciando carregamento...', 'info');
            audio.onloadedmetadata = () => {
                log(`â±ï¸ DuraÃ§Ã£o: ${audio.duration.toFixed(2)}s`, 'success');
                log(`ğŸ”Š Volume: ${audio.volume}`, 'info');
            };
            audio.onloadeddata = () => log('ğŸ“¦ Dados carregados', 'success');
            audio.oncanplay = () => log('âœ… Pronto para tocar (canplay)', 'success');
            audio.oncanplaythrough = () => log('âœ… Totalmente carregado', 'success');
            audio.onplay = () => log('â–¶ï¸ REPRODUÃ‡ÃƒO INICIADA!', 'success');
            audio.onplaying = () => log('ğŸµ REALMENTE TOCANDO!', 'success');
            audio.onpause = () => log('â¸ï¸ Pausado', 'warning');
            audio.onended = () => log('â¹ï¸ ReproduÃ§Ã£o finalizada', 'info');
            audio.onerror = (e) => {
                log(`âŒ ERRO: ${audio.error?.message || 'Desconhecido'}`, 'error');
                log(`Error code: ${audio.error?.code}`, 'error');
                log(`Network state: ${audio.networkState}`, 'error');
                log(`Ready state: ${audio.readyState}`, 'error');
            };
            
            // Definir fonte e carregar
            audio.src = audioPath;
            audio.volume = 1.0;
            audio.load();
            
            log('ğŸ”„ Arquivo carregado, tentando reproduzir...', 'info');
            
            // Tentar reproduzir
            try {
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            log('âœ… play() promise resolvida!', 'success');
                            log(`ğŸ“Š paused=${audio.paused}, currentTime=${audio.currentTime}`, 'info');
                        })
                        .catch(error => {
                            log(`âŒ play() promise rejeitada: ${error.name}`, 'error');
                            log(`Mensagem: ${error.message}`, 'error');
                            
                            if (error.name === 'NotAllowedError') {
                                log('ğŸ’¡ SOLUÃ‡ÃƒO: Toque primeiro no botÃ£o "Testar Ãudio Silencioso"', 'warning');
                            }
                        });
                }
                
            } catch (e) {
                log(`âŒ ExceÃ§Ã£o ao chamar play(): ${e.message}`, 'error');
            }
        }
        
        // Inicializar ao carregar pÃ¡gina
        window.onload = () => {
            log('ğŸš€ PÃ¡gina carregada', 'info');
            detectDevice();
            checkAudioContext();
            checkHTML5Audio();
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            log('ğŸ’¡ INSTRUÃ‡Ã•ES:', 'warning');
            log('1. Primeiro clique em "Testar Ãudio Silencioso"', 'warning');
            log('2. Depois clique em "TESTAR ÃUDIO"', 'warning');
            log('3. Verifique os logs abaixo', 'warning');
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
        };
    </script>
</body>
</html>
